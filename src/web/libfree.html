<!DOCTYPE html>
<html lang="en">
<head>
    <title>Javascript CES</title>

    <script defer>
        // this is the main "framework" Game object
        var Game = function() {
            var self = this;

            this.systems = {
                $update: [] // store update order, keep from having to loop through keys
            };

            this.entities = {
                $queryAll: function(/* components */) {
                    var ents = [];
                    var i, len;
                    for(var e in self.entities) {
                        for(i=0, len=arguments.length; i < len; i++) {
                            if(self.entities[e].hasOwnProperty(arguments[i])) {
                                ents.push(self.entities[e]);
                            }
                        }
                    }

                    return ents;
                }
            };

            this.tick = function(time) {
                var game = this;
                this.systems.$update.forEach(function(sys) {
                    game.systems[sys].update(time.frameTime);
                });
            };

            this.addSystem = function(name, system) {
                this.systems[name] = system;
                this.systems.$update.push(name);
            };

            this.addEntity = function(name, components) {
                this.entities[name] = {};
                for(var key in components) {
                    if(components.hasOwnProperty(key)) {
                        this.entities[name][key] = components[key];
                    }
                }
            };
        };

        // this just needs a canvas element, and some object with a tick method
        var run = function(element, game) {
            var startTime = performance.now();
            var lastTimestamp = startTime;
            var lastFps = startTime;

            var frame = function() {
                var timestamp = performance.now();

                requestAnimationFrame(frame, element);

                game.tick({
                    timestamp: timestamp,
                    elapsed: timestamp - startTime,
                    frameTime: Math.min(timestamp - lastTimestamp, 40),
                });

                lastTimestamp = timestamp;
            };
            requestAnimationFrame(frame, element);
        };

        // components and systems (move to own file...)
        var Position = function(x, y) {
            this.x = x;
            this.y = y;
        };

        var Velocity = function(x, y) {
            this.x = x;
            this.y = y;
        };

        var RenderSystem = function(game) {
            this.game = game;
            this.update = function(delta) {
                // clear viewport
                this.game.ctx.fillStyle = '#000';
                this.game.ctx.fillRect(0, 0, this.game.canvas.width, this.game.canvas.height);
            };
        };

        var PhysicsSystem = function(game) {
            this.game = game;
            this.update = function(delta) {
                // get all entities that have both components
                var entities = this.game.entities.$queryAll('position', 'velocity');
                // update postion over time based on velocity
                entities.forEach(function(entity) {
                    entity.position.x *= entity.velocity.x * delta;
                    entity.position.y *= entity.velocity.y * delta;
                });
            };
        };

        // this is game specific startup
        var init = function() {
            // any pre-loop shiz
            var canvas = document.getElementById('viewport');
            var myGame = new Game();

            myGame.canvas = canvas;
            myGame.ctx = canvas.getContext('2d');

            // add the rendering system
            myGame.addSystem('physics', new PhysicsSystem(myGame));
            myGame.addSystem('render', new RenderSystem(myGame));

            var Hero = function(game) {
                this.game = game;

                this.game.addEntity('hero', {position: new Position(0, 0), velocity: new Velocity(1, 0)});
            };

            run(canvas, myGame);
        };

        document.addEventListener("DOMContentLoaded", init);
    </script>
</head>
<body>
    <canvas id="viewport" width="800" height="600"></canvas>
</body>
</html>